<?PHP
/**
 * @Copyright (c) 2011 onelee Inc.
 * @author        gaoshikao@qq.com
 * @date          2013-06-19
 *
 * UPS国际速递
 */


/**
 * @class: UPSAdapter
 * @PURPOSE:  UPS国际速递
 */
class UPSAdapter {
    /* 名称*/
    const SHIP_NAME = 'UPS Shipping';

    /* 天数 */
    const SHIP_DAYS = '4-6 business days';

    /* 起重费 */
    const BASIC_FEE = 3.00;

    //配送区域
    private static $_DISPATCH_AREA = array(
        'A' => array(25,35,99,131,152,158,168,171),
        'B' => array(84),
        'C' => array(10,79,120,124),
        'D' => array(78,189),
        'E' => array(30,108),
        'F' => array(16,58,64,82,96,117,159,183,187),
        'G' => array(44,57,125,133,167),
        'H' => array(66,134),
        'I' => array(24,42,76,77,81,85,95,139,157,182),
        'J' => array(184)
    );

    //折扣计算
    private static $_AREA_DISCOUNT = array(
        'A' => 3.55,
        'B' => 3.40,
        'C' => 4.50,
        'D' => 4.50,
        'E' => 3.85,
        'F' => 3.75,
        'G' => 3.75,
        'H' => 3.85,
        'I' => 3.85,
        'J' => 3.85
    );

    //每公斤运费
    private static $_FEE_PER_KILOGRAM = array(
        'A' => array(
            '0.50' => 238.00,
            '1.00' => 281.00,
            '1.50' => 323.00,
            '2.00' => 365.00,
            '2.50' => 408.00,
            '3.00' => 451.00,
            '3.50' => 493.00,
            '4.00' => 537.00,
            '4.50' => 578.00,
            '5.00' => 621.00,
            '5.50' => 643.00,
            '6.00' => 664.00,
            '6.50' => 688.00,
            '7.00' => 709.00,
            '7.50' => 731.00,
            '8.00' => 756.00,
            '8.50' => 780.00,
            '9.00' => 805.00,
            '9.50' => 828.00,
            '10.00' => 853.00,
            '10.50' => 883.00,
            '11.00' => 915.00,
            '11.50' => 944.00,
            '12.00' => 975.00,
            '12.50' => 1007.00,
            '13.00' => 1037.00,
            '13.50' => 1068.00,
            '14.00' => 1101.00,
            '14.50' => 1132.00,
            '15.00' => 1164.00,
            '15.50' => 1189.00,
            '16.00' => 1217.00,
            '16.50' => 1245.00,
            '17.00' => 1271.00,
            '17.50' => 1298.00,
            '18.00' => 1312.00,
            '18.50' => 1328.00,
            '19.00' => 1337.00,
            '19.50' => 1347.00,
            '20.00' => 1352.00
        ),
        'B' => array(
            '0.50' => 317.00,
            '1.00' => 375.00,
            '1.50' => 434.00,
            '2.00' => 492.00,
            '2.50' => 551.00,
            '3.00' => 611.00,
            '3.50' => 669.00,
            '4.00' => 728.00,
            '4.50' => 786.00,
            '5.00' => 845.00,
            '5.50' => 902.00,
            '6.00' => 963.00,
            '6.50' => 1022.00,
            '7.00' => 1083.00,
            '7.50' => 1142.00,
            '8.00' => 1201.00,
            '8.50' => 1259.00,
            '9.00' => 1317.00,
            '9.50' => 1376.00,
            '10.00' => 1434.00,
            '10.50' => 1484.00,
            '11.00' => 1533.00,
            '11.50' => 1581.00,
            '12.00' => 1630.00,
            '12.50' => 1677.00,
            '13.00' => 1727.00,
            '13.50' => 1776.00,
            '14.00' => 1824.00,
            '14.50' => 1873.00,
            '15.00' => 1921.00,
            '15.50' => 1963.00,
            '16.00' => 2005.00,
            '16.50' => 2045.00,
            '17.00' => 2087.00,
            '17.50' => 2128.00,
            '18.00' => 2167.00,
            '18.50' => 2206.00,
            '19.00' => 2226.00,
            '19.50' => 2243.00,
            '20.00' => 2252.00
        ),
        'C' => array(
            '0.50' => 321.00,
            '1.00' => 379.00,
            '1.50' => 438.00,
            '2.00' => 496.00,
            '2.50' => 557.00,
            '3.00' => 614.00,
            '3.50' => 673.00,
            '4.00' => 731.00,
            '4.50' => 791.00,
            '5.00' => 850.00,
            '5.50' => 908.00,
            '6.00' => 968.00,
            '6.50' => 1028.00,
            '7.00' => 1089.00,
            '7.50' => 1148.00,
            '8.00' => 1207.00,
            '8.50' => 1264.00,
            '9.00' => 1324.00,
            '9.50' => 1382.00,
            '10.00' => 1441.00,
            '10.50' => 1490.00,
            '11.00' => 1540.00,
            '11.50' => 1591.00,
            '12.00' => 1640.00,
            '12.50' => 1690.00,
            '13.00' => 1742.00,
            '13.50' => 1791.00,
            '14.00' => 1841.00,
            '14.50' => 1892.00,
            '15.00' => 1941.00,
            '15.50' => 1985.00,
            '16.00' => 2027.00,
            '16.50' => 2069.00,
            '17.00' => 2111.00,
            '17.50' => 2155.00,
            '18.00' => 2198.00,
            '18.50' => 2241.00,
            '19.00' => 2284.00,
            '19.50' => 2295.00,
            '20.00' => 2308.00
        ),
        'D' => array(
            '0.50' => 518.00,
            '1.00' => 586.00,
            '1.50' => 656.00,
            '2.00' => 726.00,
            '2.50' => 795.00,
            '3.00' => 864.00,
            '3.50' => 933.00,
            '4.00' => 1002.00,
            '4.50' => 1072.00,
            '5.00' => 1142.00,
            '5.50' => 1200.00,
            '6.00' => 1256.00,
            '6.50' => 1314.00,
            '7.00' => 1371.00,
            '7.50' => 1428.00,
            '8.00' => 1486.00,
            '8.50' => 1542.00,
            '9.00' => 1600.00,
            '9.50' => 1657.00,
            '10.00' => 1714.00,
            '10.50' => 1760.00,
            '11.00' => 1806.00,
            '11.50' => 1854.00,
            '12.00' => 1900.00,
            '12.50' => 1946.00,
            '13.00' => 2003.00,
            '13.50' => 2059.00,
            '14.00' => 2114.00,
            '14.50' => 2171.00,
            '15.00' => 2227.00,
            '15.50' => 2282.00,
            '16.00' => 2340.00,
            '16.50' => 2395.00,
            '17.00' => 2451.00,
            '17.50' => 2508.00,
            '18.00' => 2510.00,
            '18.50' => 2515.00,
            '19.00' => 2525.00,
            '19.50' => 2536.00,
            '20.00' => 2544.00
        ),
        'E' => array(
            '0.50' => 394.00,
            '1.00' => 456.00,
            '1.50' => 521.00,
            '2.00' => 584.00,
            '2.50' => 646.00,
            '3.00' => 712.00,
            '3.50' => 776.00,
            '4.00' => 842.00,
            '4.50' => 905.00,
            '5.00' => 971.00,
            '5.50' => 1025.00,
            '6.00' => 1081.00,
            '6.50' => 1134.00,
            '7.00' => 1188.00,
            '7.50' => 1245.00,
            '8.00' => 1300.00,
            '8.50' => 1355.00,
            '9.00' => 1413.00,
            '9.50' => 1468.00,
            '10.00' => 1524.00,
            '10.50' => 1572.00,
            '11.00' => 1619.00,
            '11.50' => 1667.00,
            '12.00' => 1714.00,
            '12.50' => 1761.00,
            '13.00' => 1810.00,
            '13.50' => 1858.00,
            '14.00' => 1905.00,
            '14.50' => 1953.00,
            '15.00' => 2001.00,
            '15.50' => 2051.00,
            '16.00' => 2103.00,
            '16.50' => 2154.00,
            '17.00' => 2204.00,
            '17.50' => 2256.00,
            '18.00' => 2294.00,
            '18.50' => 2333.00,
            '19.00' => 2372.00,
            '19.50' => 2411.00,
            '20.00' => 2429.00
        ),
        'F' => array(
            '0.50' => 493.00,
            '1.00' => 583.00,
            '1.50' => 672.00,
            '2.00' => 762.00,
            '2.50' => 851.00,
            '3.00' => 918.00,
            '3.50' => 983.00,
            '4.00' => 1049.00,
            '4.50' => 1114.00,
            '5.00' => 1181.00,
            '5.50' => 1235.00,
            '6.00' => 1292.00,
            '6.50' => 1346.00,
            '7.00' => 1400.00,
            '7.50' => 1456.00,
            '8.00' => 1508.00,
            '8.50' => 1562.00,
            '9.00' => 1616.00,
            '9.50' => 1670.00,
            '10.00' => 1723.00,
            '10.50' => 1778.00,
            '11.00' => 1833.00,
            '11.50' => 1888.00,
            '12.00' => 1942.00,
            '12.50' => 1996.00,
            '13.00' => 2053.00,
            '13.50' => 2107.00,
            '14.00' => 2161.00,
            '14.50' => 2217.00,
            '15.00' => 2272.00,
            '15.50' => 2306.00,
            '16.00' => 2341.00,
            '16.50' => 2373.00,
            '17.00' => 2408.00,
            '17.50' => 2442.00,
            '18.00' => 2477.00,
            '18.50' => 2511.00,
            '19.00' => 2546.00,
            '19.50' => 2578.00,
            '20.00' => 2612.00
        ),
        'G' => array(
            '0.50' => 493.00,
            '1.00' => 592.00,
            '1.50' => 677.00,
            '2.00' => 764.00,
            '2.50' => 861.00,
            '3.00' => 946.00,
            '3.50' => 1009.00,
            '4.00' => 1068.00,
            '4.50' => 1130.00,
            '5.00' => 1189.00,
            '5.50' => 1245.00,
            '6.00' => 1298.00,
            '6.50' => 1351.00,
            '7.00' => 1406.00,
            '7.50' => 1462.00,
            '8.00' => 1520.00,
            '8.50' => 1581.00,
            '9.00' => 1639.00,
            '9.50' => 1701.00,
            '10.00' => 1759.00,
            '10.50' => 1816.00,
            '11.00' => 1870.00,
            '11.50' => 1923.00,
            '12.00' => 1979.00,
            '12.50' => 2034.00,
            '13.00' => 2087.00,
            '13.50' => 2142.00,
            '14.00' => 2195.00,
            '14.50' => 2248.00,
            '15.00' => 2302.00,
            '15.50' => 2348.00,
            '16.00' => 2395.00,
            '16.50' => 2441.00,
            '17.00' => 2486.00,
            '17.50' => 2533.00,
            '18.00' => 2558.00,
            '18.50' => 2583.00,
            '19.00' => 2606.00,
            '19.50' => 2631.00,
            '20.00' => 2648.00
        ),
        'H' => array(
            '0.50' => 607.00,
            '1.00' => 709.00,
            '1.50' => 811.00,
            '2.00' => 915.00,
            '2.50' => 1016.00,
            '3.00' => 1119.00,
            '3.50' => 1221.00,
            '4.00' => 1324.00,
            '4.50' => 1423.00,
            '5.00' => 1523.00,
            '5.50' => 1615.00,
            '6.00' => 1704.00,
            '6.50' => 1792.00,
            '7.00' => 1882.00,
            '7.50' => 1971.00,
            '8.00' => 2044.00,
            '8.50' => 2130.00,
            '9.00' => 2218.00,
            '9.50' => 2305.00,
            '10.00' => 2391.00,
            '10.50' => 2459.00,
            '11.00' => 2525.00,
            '11.50' => 2593.00,
            '12.00' => 2659.00,
            '12.50' => 2726.00,
            '13.00' => 2794.00,
            '13.50' => 2859.00,
            '14.00' => 2928.00,
            '14.50' => 2994.00,
            '15.00' => 3060.00,
            '15.50' => 3119.00,
            '16.00' => 3175.00,
            '16.50' => 3234.00,
            '17.00' => 3290.00,
            '17.50' => 3346.00,
            '18.00' => 3357.00,
            '18.50' => 3364.00,
            '19.00' => 3374.00,
            '19.50' => 3381.00,
            '20.00' => 3389.00
        ),
        'I' => array(
            '0.50' => 800.00,
            '1.00' => 1019.00,
            '1.50' => 1241.00,
            '2.00' => 1462.00,
            '2.50' => 1682.00,
            '3.00' => 1901.00,
            '3.50' => 2121.00,
            '4.00' => 2341.00,
            '4.50' => 2559.00,
            '5.00' => 2778.00,
            '5.50' => 2932.00,
            '6.00' => 3085.00,
            '6.50' => 3240.00,
            '7.00' => 3393.00,
            '7.50' => 3546.00,
            '8.00' => 3699.00,
            '8.50' => 3853.00,
            '9.00' => 4006.00,
            '9.50' => 4161.00,
            '10.00' => 4314.00,
            '10.50' => 4468.00,
            '11.00' => 4621.00,
            '11.50' => 4775.00,
            '12.00' => 4927.00,
            '12.50' => 5082.00,
            '13.00' => 5203.00,
            '13.50' => 5326.00,
            '14.00' => 5447.00,
            '14.50' => 5569.00,
            '15.00' => 5691.00,
            '15.50' => 5815.00,
            '16.00' => 5937.00,
            '16.50' => 6060.00,
            '17.00' => 6182.00,
            '17.50' => 6307.00,
            '18.00' => 6428.00,
            '18.50' => 6550.00,
            '19.00' => 6671.00,
            '19.50' => 6794.00,
            '20.00' => 6915.00
        ),
        'J' => array(
            '0.50' => 394.00,
            '1.00' => 456.00,
            '1.50' => 521.00,
            '2.00' => 584.00,
            '2.50' => 646.00,
            '3.00' => 712.00,
            '3.50' => 776.00,
            '4.00' => 842.00,
            '4.50' => 905.00,
            '5.00' => 971.00,
            '5.50' => 1025.00,
            '6.00' => 1081.00,
            '6.50' => 1134.00,
            '7.00' => 1188.00,
            '7.50' => 1245.00,
            '8.00' => 1300.00,
            '8.50' => 1355.00,
            '9.00' => 1413.00,
            '9.50' => 1468.00,
            '10.00' => 1524.00,
            '10.50' => 1572.00,
            '11.00' => 1619.00,
            '11.50' => 1667.00,
            '12.00' => 1714.00,
            '12.50' => 1761.00,
            '13.00' => 1810.00,
            '13.50' => 1858.00,
            '14.00' => 1905.00,
            '14.50' => 1953.00,
            '15.00' => 2001.00,
            '15.50' => 2051.00,
            '16.00' => 2103.00,
            '16.50' => 2154.00,
            '17.00' => 2204.00,
            '17.50' => 2256.00,
            '18.00' => 2294.00,
            '18.50' => 2333.00,
            '19.00' => 2372.00,
            '19.50' => 2411.00,
            '20.00' => 2429.00
        )
    );

    //计算费用，重量参数单位是克
    public static function CalcFee($nation_id, $weight, $amount){
        $area = self::checkSupport($nation_id);
        if (!$area) return 0;

        //计算重量费用
        $weight /= 1000;
        $weightFee = 0;
        foreach (self::$_FEE_PER_KILOGRAM[$area] as $k => $v) {
            if ($weight <= floatval($k)) {
                $weightFee = $v;
                break;
            }
        }
        if ($weightFee == 0) {
            $weightFee = $v;
        }
        $weightFee *= self::$_AREA_DISCOUNT[$area] / 10;

        $totalFee = self::BASIC_FEE + $weightFee;
        $totalFee = ExchangeRate::getCurrencyPrice($totalFee);
        $totalFee *= 1.2;
        return number_format($totalFee, 2, '.', '');
    }

    //判断一个国家是否支持此邮寄方式，并返回所支持的区域id
    public static function checkSupport($nation_id){
        foreach (self::$_DISPATCH_AREA as $id => $area) {
            if (in_array($nation_id, $area) and array_key_exists($id, self::$_FEE_PER_KILOGRAM)) {
                return $id;
            }
        }
        return 0;
    }

}

